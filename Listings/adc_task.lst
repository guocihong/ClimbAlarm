C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE ADC_TASK
OBJECT MODULE PLACED IN .\Objects\adc_task.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE task\adc\adc_task.c OMF2 OPTIMIZE(8,SPEED) BROWSE DEBUG PRINT(.\Listings
                    -\adc_task.lst) OBJECT(.\Objects\adc_task.obj)

line level    source

   1          #include "task/adc/adc_task.h"
   2          
   3          /* for AD */
   4          #define AD_EQU_PNUM            4                     //Ã¿µÀ¸ÖË¿²ÉÑù4´ÎÇóÆ½¾ùÖµ
   5          
   6          extern  data  sAD_Sample  ad_sample;         //±£´æµ±Ç°²ÉÑùÖµ
   7          extern idata  sAD_Sum     ad_samp_equ;       //¾ùºâÈ¥àÐÉùÇóºÍ
   8          extern xdata  Union16     ad_chn_sample;     //×îÐÂÒ»ÂÖ²ÉÑùÖµ£¨ÒÑ¾ùºâÈ¥ÔëÉù£¬Ã¿Í¨µÀÒ»¸öµã£¬Ñ­»·±£´æ£©
   9          extern idata  Uint16      ad_samp_pnum;      //²ÉÑùµãÊý(¼ÆËã¾²Ì¬»ù×¼ÖµÊ±×Ü²ÉÑùµãÊý)
  10          extern idata  sAD_Sum     ad_samp_sum;       //½×¶ÎÇóºÍ
  11          extern xdata  sAD_BASE    ad_chn_base;       //¸÷Í¨µÀÔËÐÐÊ±¾²Ì¬»ù×¼Öµ/ÉÏÏÂÏÞ·§Öµ£¨µ¥Î»£º²ÉÑùÖµ£©
  12          extern  data  Byte        ad_chn_over;       //¸÷Í¨µÀÁ¬Ðø²ÉÑùµã(¾ùºâºó)µÄ·§ÖµÅÐ¶¨£º 0 - ·¶Î§ÄÚ£» 1 - ³¬·§Ö
             -µ
  13          extern xdata  Byte        ad_still_Dup;      //±¨¾¯·§ÖµÉÏÏÞ
  14          extern idata  Uint16      ad_alarm_exts;     //ÍâÁ¦±¨¾¯±êÖ¾£¨ÎÞmask£©£º Î»Öµ 0 - ÎÞ£» 1 - ³¬·§Öµ
  15          
  16          /* for this task: ÓÃÓÚ»ù×¼Öµ¸ú×Ù */
  17          static idata  Byte        md_point;          //ÓÃÓÚ»ù×¼Öµ¸ú×ÙµÄ¼ÆÁ¿µãÊý
  18          
  19          /* for system */
  20          extern idata  Byte        system_status;     //ÏµÍ³×´Ì¬
  21          
  22          /* variables for alarm output */
  23          extern data   Uint16      ad_alarm_tick;     //¸÷Í¨µÀ±¨¾¯¼ÆÊ±tick
  24          extern bdata  bit         ad_alarm_flag;     //ÍâÁ¦±¨¾¯±êÖ¾
  25          static xdata  Uint16      alarm_led_flag;        //LED±¨¾¯Ö¸Ê¾: 0 - ÎÞ±¨¾¯£¨Ãð£©£»1 - ±¨¾¯£¨ÁÁ£©
  26          
  27          void adc_task_init(void)
  28          {
  29   1              //Ïà¹Ø±äÁ¿³õÊ¼»¯
  30   1              ad_sample.valid = 0;                     //¿ÕÏÐ£¬¿ÉÒÔÐ´ÈëÐÂÖµ
  31   1              ad_samp_pnum    = 0;                     //²ÉÑùµãÊý(¼ÆËã¾²Ì¬»ù×¼ÖµÊ±×Ü²ÉÑùµãÊý)
  32   1              ad_samp_equ.sum       = 0;                   //¾ùºâÈ¥àÐÉùÇóºÍ
  33   1              ad_samp_equ.point     = 0;
  34   1              ad_samp_sum.sum       = 0;                   //½×¶ÎÇóºÍ
  35   1              ad_samp_sum.point     = 0;
  36   1              ad_chn_sample.w       = 0;                   //×îÐÂÒ»ÂÖ²ÉÑùÖµ
  37   1              ad_chn_base.base      = 0;                   //¸÷Í¨µÀ¾²Ì¬»ù×¼Öµ/ÉÏÏÂÏÞ·§Öµ
  38   1              ad_chn_base.base_down = 0;
  39   1              ad_chn_base.base_up   = 0;
  40   1              ad_chn_over           = 0x00;            //¸÷Í¨µÀÁ¬Ðø²ÉÑùµã(¾ùºâºó)µÄ·§ÖµÅÐ¶¨£º¾ùÔÚ·¶Î§ÄÚ
  41   1              md_point              = 0;               //ÓÃÓÚ»ù×¼Öµ¸ú×ÙµÄ¼ÆÁ¿µãÊý
  42   1              ad_alarm_tick         = 0x00;
  43   1      
  44   1              ad_alarm_exts   = 0;                                     //ÍâÁ¦±¨¾¯±êÖ¾£¨ÎÞmask£©: ÎÞ
  45   1              alarm_led_flag  = 0;                     //ËùÓÐ±¨¾¯LEDÎªÃð
  46   1              ad_alarm_flag   = 0;
  47   1      
  48   1              //adcÓ²¼þ³õÊ¼»¯
  49   1              adc_init();
  50   1      }
  51          
  52          void adc_task(void)
  53          {
C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 2   

  54   1              Uint16  temp16;         //ÁÙÊ±±äÁ¿
  55   1              Uint16  val_temp;       //ÐÂËÍÈëµÄ10bit²ÉÑùÖµ,  ºó×÷ÁÙÊ±±äÁ¿
  56   1              Uint16  val;            //4µã¾ùºâºóµÃµ½µÄÆ½¾ù²ÉÑùÖµ, ×÷ÎªÒ»¸ö¿É½øÐÐ³¬ÏÞÅÐ¶ÏµÄ×îÐ¡µã
  57   1      
  58   1              if (ad_sample.valid) {  //ÓÐÐÂ²ÉÑùÊý¾Ýµ½´ï
  59   2                      // 0. ±£´æµ½ÁÙÊ±±äÁ¿
  60   2                      val_temp = ad_sample.val;
  61   2      
  62   2                      // 1. ±£´æµ½¾ùºâÈ¥àÐÉùÇóºÍÖÐ
  63   2                      ad_samp_equ.sum += val_temp;
  64   2                      ad_samp_equ.point++;
  65   2      
  66   2                      // 2. µ±Ç°Í¨µÀÊÇ·ñÂú×ãÈ¥àÐÉùµãÊý
  67   2                      if (ad_samp_equ.point == AD_EQU_PNUM) {
  68   3                              // ÒÑÂúÈ¥àÐÉùµãÊý£¬¿ÉÇó³ö¾ùºâºóµÄÒ»¸öµã
  69   3                              // 2.a Çó³ö¶ÔÓ¦Í¨µÀµÄÒ»¸ö²ÉÑùµã
  70   3                              val = ad_samp_equ.sum >> 2;  //³ýÓÚ4
  71   3      
  72   3                              // 2.b ÇåÁãµ±Ç°Í¨µÀµÄÈ¥àÐÉùÇóºÍ½á¹¹
  73   3                              ad_samp_equ.sum = 0;
  74   3                              ad_samp_equ.point = 0;
  75   3      
  76   3                              // 2.c ±£´æÊµÊ±²ÉÑùÖµ
  77   3                              ad_chn_sample.w = val;   //±£´æµ½×îÐÂÒ»ÂÖ²ÉÑùÖµÊý×éÖÐ
  78   3      
  79   3                              // 2.d ÓÉÏµÍ³×´Ì¬¾ö¶¨Êý¾ÝµÄ´¦Àí
  80   3                              switch (system_status)
  81   3                              {
  82   4                              case SYS_PowerON:   //ÉÏµç
  83   4                              case SYS_B5S:       //5ÃëÑÓÊ±
  84   4                                      break;
  85   4      
  86   4                              case SYS_SAMP_BASE: //³õÊ¼ÉÏµçÊ±µÄ¾²Ì¬»ù×¼Öµ²ÉÑù
  87   4                                      //´æÈë½×¶ÎºÍ
  88   4                                      ad_samp_sum.sum += val;
  89   4                                      ad_samp_pnum++;
  90   4                                      if (ad_samp_pnum == 32) {
  91   5                                              //ÒÑ¾­Âú»ù×¼Öµ²ÉÑùµãÊý£¨Ã¿Í¨µÀ32µã)
  92   5                                              //1.¼ÆËã¾ùÖµºÍÉÏÏÂÏÞ
  93   5                                              //»ù×¼
  94   5                                              ad_chn_base.base = ad_samp_sum.sum >> 5;   //³ýÓÚ32
  95   5      
  96   5                                              //ÏÂÏÞ = »ù×¼ * £¨1 / 3£©
  97   5                                              val_temp = ad_chn_base.base;
  98   5                          ad_chn_base.base_down = val_temp - ad_still_Dup;
  99   5      
 100   5                                              //ÉÏÏÞ
 101   5                                              if ((1023 - ad_chn_base.base) > ad_still_Dup) {
 102   6                                                      ad_chn_base.base_up = ad_chn_base.base + ad_still_Dup;
 103   6                                              } else {
 104   6                                                      ad_chn_base.base_up = 1023;
 105   6                                              }
 106   5      
 107   5                                              //¸´Î»½×¶ÎºÍ±äÁ¿£¬×¼±¸ÓÃÓÚ×ÔÊÊÓ¦·§Öµ¸ú×Ù
 108   5                                              ad_samp_sum.sum   = 0;
 109   5                                              ad_samp_sum.point = 0;
 110   5      
 111   5                                              //2.e ×´Ì¬-> ÊµÊ±¼ì²â
 112   5                                              system_status = SYS_CHECK;
 113   5                                      }
 114   4      
 115   4                                      break;
C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 3   

 116   4      
 117   4                              case SYS_CHECK: //ÊµÊ±¼ì²â
 118   4                                      //2. ÅÐ¶ÏÊÇ·ñÍâÁ¦±¨¾¯
 119   4                                      ad_chn_over = ad_chn_over << 1;   //Bit0Ìî0£¬Òò´ËÈ±Ê¡ÔÚÔÊÐí·¶Î§ÄÚ
 120   4                                      if ((val >= ad_chn_base.base_down) && (val <= ad_chn_base.base_up)) {
 121   5                                              //ÔÚÕÅÁ¦ÉÏ/ÏÂÏÞÔÊÐí·¶Î§ÄÚ
 122   5                                              //a. Çå±êÖ¾(È±Ê¡)
 123   5                                              //b. ¼ÆÈë¸ú×Ù»ù×¼ÖµÇóºÍÖÐ
 124   5                                              ad_samp_sum.sum += val;
 125   5                                              ad_samp_sum.point++;
 126   5      
 127   5                                              if (ad_samp_sum.point == 2) {
 128   6                                                      //Âú2µã(Ô¼Ðè0.6Ãë)
 129   6                                                      //b.0 ¼ÆËãÕâ2µã¾ùÖµ
 130   6                                                      val_temp = ad_samp_sum.sum >> 1;   //³ýÓÚ2, µÃµ½Õâ2µãµÄ¾ùÖµ
 131   6                                                      //b.1 ¸üÐÂ»ù×¼Öµ
 132   6                                                      if (ad_chn_base.base > (val_temp + 1)) {                            
 133   7                                  // ÖÁÉÙÐ¡ÓÚ2,»ºÂýËÉ³Ú
 134   7                                                              md_point++;
 135   7                                                              if (md_point >= DEF_ModiBASE_PT) {
 136   8                                      // ÒÑÂú»ºÂýËÉ³ÚÊ±µÄÁ¬Ðø¼ÆÁ¿µãÊý, ½øÐÐÒ»´Î¸ú×Ù
 137   8                                                                      // 1. ¸ú×Ù»ù×¼Öµ
 138   8                                     if (ad_chn_base.base > 0) {
 139   9                                          //¿ÉÒÔµÝ¼õ1
 140   9                                          ad_chn_base.base--;
 141   9                                          // Í¬²½¸üÐÂÉÏÏÂÏÞ
 142   9                                          val_temp = ad_chn_base.base;
 143   9                                          if ((val_temp - ad_still_Dup) > 0) {
 144  10                                              ad_chn_base.base_down = val_temp - ad_still_Dup;
 145  10                                          }
 146   9                                          
 147   9                                          if (ad_chn_base.base_up > 0) {
 148  10                                              ad_chn_base.base_up--;
 149  10                                          }
 150   9                                      }
 151   8                                                                      // 2. Çå»ºÂýËÉ³Ú¸ú×Ù±äÁ¿
 152   8                                                                      md_point = 0;
 153   8                                                              }
 154   7                                                      } else if (val_temp > (ad_chn_base.base + 1)) {
 155   7                                                              // ÖÁÉÙ´ó2, »ºÂýÕÅ½ô
 156   7                                                              md_point++;
 157   7                                                              if (md_point >= DEF_ModiBASE_PT) {
 158   8                                                                      // ÒÑÂú»ºÂýÕÅ½ôÊ±µÄÁ¬Ðø¼ÆÁ¿µãÊý, ½øÐÐÒ»´Î¸ú×Ù
 159   8                                                                      // 1. ¸ú×Ù»ù×¼Öµ
 160   8                                                                      if (ad_chn_base.base < 1023) {
 161   9                                                                              //¿ÉÒÔµÝÔö1
 162   9                                                                              ad_chn_base.base++;
 163   9                                                                              // Í¬²½¸üÐÂÉÏÏÂÏÞ
 164   9                                                                              val_temp = ad_chn_base.base;
 165   9                                          ad_chn_base.base_down = val_temp - ad_still_Dup;
 166   9                                                                              if (ad_chn_base.base_up < 1023) {
 167  10                                                                                      ad_chn_base.base_up++;
 168  10                                                                              }
 169   9                                                                      }
 170   8                                                                      // 2. Çå»ºÂýÕÅ½ô¸ú×Ù±äÁ¿
 171   8                                                                      md_point = 0;
 172   8                                                              }
 173   7                                                      }
 174   6      
 175   6                                                      //b.2 ¸´Î»½×¶ÎºÍ±äÁ¿ - ÓÃÓÚ4µã4µãÆ½¾ùµÄÇóºÍ½á¹¹
 176   6                                                      ad_samp_sum.sum   = 0;
 177   6                                                      ad_samp_sum.point = 0;
C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 4   

 178   6                                              }
 179   5                                      } else {
 180   5                                              //ÍâÁ¦±¨¾¯, ÖÃ±êÖ¾
 181   5                                              ad_chn_over |= 0x01;
 182   5                                      }
 183   4      
 184   4                                      //2.4 Á¬Ðø4µã³¬·¶Î§£¬´ËÍ¨µÀÓÐÍâÁ¦±¨¾¯
 185   4                                      if ((ad_chn_over & 0x0F) == 0x0F) {
 186   5                                              //ÖÃÍâÁ¦±¨¾¯±êÖ¾
 187   5                                              ad_alarm_exts |= (Uint16)0x01;
 188   5      
 189   5                                              //±¨¾¯¼ÆÊ±tickÇåÁã
 190   5                                              ad_alarm_tick = 0;
 191   5      
 192   5                                              //Á¢¼´¸üÐÂ»úÖÆ
 193   5                                              ad_chn_base.base = val;
 194   5                                              val_temp = ad_chn_base.base;
 195   5                          ad_chn_base.base_down = val_temp - ad_still_Dup;
 196   5                                              if ((1023 - ad_chn_base.base) > ad_still_Dup) {
 197   6                                                      ad_chn_base.base_up = ad_chn_base.base + ad_still_Dup;
 198   6                                              } else {
 199   6                                                      ad_chn_base.base_up = 1023;
 200   6                                              }
 201   5      
 202   5                                              //¸´Î»½×¶ÎºÍ±äÁ¿ - ÓÃÓÚ4µã4µãÆ½¾ùµÄÇóºÍ½á¹¹
 203   5                                              ad_samp_sum.sum = 0;
 204   5                                              ad_samp_sum.point = 0;
 205   5      
 206   5                                              //Çå»ºÂýÕÅ½ô¸ú×Ù±äÁ¿
 207   5                                              md_point = 0;   //ÓÃÓÚ»ù×¼Öµ¸ú×ÙµÄ¼ÆÁ¿µãÊý
 208   5                                      } else if ((ad_chn_over & 0x0F) == 0x00) {
 209   5                                              //ÎÞÍâÁ¦±¨¾¯
 210   5                                              //¼ì²é±¨¾¯Ê±¼äÊÇ·ñÒÑµ½
 211   5                                              if (ad_alarm_tick > ALARM_TEMPO) {
 212   6                                                      //±¨¾¯ÒÑ¾­µ½×î´ó±¨¾¯Ê±¼ä, Í£Ö¹±¨¾¯
 213   6                                                      ad_alarm_exts &= ~((Uint16)0x01);
 214   6                                              }
 215   5                                      }
 216   4      
 217   4                                      //3 LEDÖ¸Ê¾(ÎÞmask)
 218   4                                      temp16 = ad_alarm_exts & 0x0001;
 219   4                                      if (alarm_led_flag != temp16) {
 220   5                                              //LEDÖ¸Ê¾ÐÅÏ¢ÓÐ±ä»¯
 221   5                                              alarm_led_flag = temp16;
 222   5                                              P33 = !P33;
 223   5                                      }
 224   4      
 225   4                                      //4 ¸üÐÂ±¨¾¯±êÖ¾
 226   4                                      temp16 = ad_alarm_exts & 0x0001;
 227   4                                      if (temp16 == 0) {
 228   5                                              ad_alarm_flag = 0;   //ÎÞ±¨¾¯
 229   5                                      } else {
 230   5                                              ad_alarm_flag = 1;   //ÓÐ±¨¾¯
 231   5                                      }
 232   4      
 233   4                                      break;
 234   4                              }
 235   3      
 236   3                              //3.µ±Ç°²ÉÑùÖµ´¦ÀíÍê±Ï£¬ÔÊÐíÐÂµÄ²ÉÑùÖµÊäÈë
 237   3                              ad_sample.valid = FALSE;
 238   3                      }
 239   2              }
C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 5   

 240   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    792    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      2    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
   IDATA SIZE       =      1    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
