C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE ADC_TASK
OBJECT MODULE PLACED IN .\Objects\adc_task.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE task\adc\adc_task.c OMF2 OPTIMIZE(8,SPEED) BROWSE DEBUG PRINT(.\Listings
                    -\adc_task.lst) OBJECT(.\Objects\adc_task.obj)

line level    source

   1          #include "task/adc/adc_task.h"
   2          
   3          /* for AD */
   4          #define AD_EQU_PNUM            4                     //√øµ¿∏÷Àø≤…—˘4¥Œ«Û∆Ωæ˘÷µ
   5          
   6          extern  data  sAD_Sample  ad_sample;         //±£¥Êµ±«∞≤…—˘÷µ
   7          extern idata  sAD_Sum     ad_samp_equ;       //æ˘∫‚»•‡–…˘«Û∫Õ
   8          extern xdata  Union16     ad_chn_sample;     //◊Ó–¬“ª¬÷≤…—˘÷µ£®“—æ˘∫‚»•‘Î…˘£¨√øÕ®µ¿“ª∏ˆµ„£¨—≠ª∑±£¥Ê£©
   9          extern idata  Uint16      ad_samp_pnum;      //≤…—˘µ„ ˝(º∆À„æ≤Ã¨ª˘◊º÷µ ±◊‹≤…—˘µ„ ˝)
  10          extern idata  sAD_Sum     ad_samp_sum;       //Ω◊∂Œ«Û∫Õ
  11          extern xdata  sAD_BASE    ad_chn_base;       //∏˜Õ®µ¿‘À–– ±æ≤Ã¨ª˘◊º÷µ/…œœ¬œﬁ∑ß÷µ£®µ•Œª£∫≤…—˘÷µ£©
  12          extern  data  Byte        ad_chn_over;       //∏˜Õ®µ¿¡¨–¯≤…—˘µ„(æ˘∫‚∫Û)µƒ∑ß÷µ≈–∂®£∫ 0 - ∑∂Œßƒ⁄£ª 1 - ≥¨∑ß÷
             -µ
  13          extern xdata  Byte        ad_still_Dup;      //±®æØ∑ß÷µ…œœﬁ
  14          extern idata  Uint16      ad_alarm_exts;     //Õ‚¡¶±®æØ±Í÷æ£®Œﬁmask£©£∫ Œª÷µ 0 - Œﬁ£ª 1 - ≥¨∑ß÷µ
  15          
  16          /* for this task: ”√”⁄ª˘◊º÷µ∏˙◊Ÿ */
  17          static idata  Byte        md_point;          //”√”⁄ª˘◊º÷µ∏˙◊Ÿµƒº∆¡øµ„ ˝
  18          
  19          /* for system */
  20          extern idata  Byte        system_status;     //œµÕ≥◊¥Ã¨
  21          
  22          /* variables for alarm output */
  23          extern data   Uint16      ad_alarm_tick;     //∏˜Õ®µ¿±®æØº∆ ±tick
  24          extern bdata  bit         ad_alarm_flag;     //Õ‚¡¶±®æØ±Í÷æ
  25          static xdata  Uint16      alarm_led_flag;        //LED±®æØ÷∏ æ: 0 - Œﬁ±®æØ£®√£©£ª1 - ±®æØ£®¡¡£©
  26          
  27          void adc_task_init(void)
  28          {
  29   1              //œ‡πÿ±‰¡ø≥ı ºªØ
  30   1              ad_sample.valid = 0;                     //ø’œ–£¨ø…“‘–¥»Î–¬÷µ
  31   1              ad_samp_pnum    = 0;                     //≤…—˘µ„ ˝(º∆À„æ≤Ã¨ª˘◊º÷µ ±◊‹≤…—˘µ„ ˝)
  32   1              ad_samp_equ.sum       = 0;                   //æ˘∫‚»•‡–…˘«Û∫Õ
  33   1              ad_samp_equ.point     = 0;
  34   1              ad_samp_sum.sum       = 0;                   //Ω◊∂Œ«Û∫Õ
  35   1              ad_samp_sum.point     = 0;
  36   1              ad_chn_sample.w       = 0;                   //◊Ó–¬“ª¬÷≤…—˘÷µ
  37   1              ad_chn_base.base      = 0;                   //∏˜Õ®µ¿æ≤Ã¨ª˘◊º÷µ/…œœ¬œﬁ∑ß÷µ
  38   1              ad_chn_base.base_down = 0;
  39   1              ad_chn_base.base_up   = 0;
  40   1              ad_chn_over           = 0x00;            //∏˜Õ®µ¿¡¨–¯≤…—˘µ„(æ˘∫‚∫Û)µƒ∑ß÷µ≈–∂®£∫æ˘‘⁄∑∂Œßƒ⁄
  41   1              md_point              = 0;               //”√”⁄ª˘◊º÷µ∏˙◊Ÿµƒº∆¡øµ„ ˝
  42   1              ad_alarm_tick         = 0x00;
  43   1      
  44   1              ad_alarm_exts   = 0;                                     //Õ‚¡¶±®æØ±Í÷æ£®Œﬁmask£©: Œﬁ
  45   1              alarm_led_flag  = 0;                     //À˘”–±®æØLEDŒ™√
  46   1              ad_alarm_flag   = 0;
  47   1      
  48   1              //adc”≤º˛≥ı ºªØ
  49   1              adc_init();
  50   1      }
  51          
  52          void adc_task(void)
  53          {
C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 2   

  54   1              Uint16  temp16;         //¡Ÿ ±±‰¡ø
  55   1              Uint16  val_temp;       //–¬ÀÕ»Îµƒ10bit≤…—˘÷µ,  ∫Û◊˜¡Ÿ ±±‰¡ø
  56   1              Uint16  val;            //4µ„æ˘∫‚∫Ûµ√µΩµƒ∆Ωæ˘≤…—˘÷µ, ◊˜Œ™“ª∏ˆø…Ω¯––≥¨œﬁ≈–∂œµƒ◊Ó–°µ„
  57   1      
  58   1              if (ad_sample.valid) {  //”––¬≤…—˘ ˝æ›µΩ¥Ô
  59   2                      // 0. ±£¥ÊµΩ¡Ÿ ±±‰¡ø
  60   2                      val_temp = ad_sample.val;
  61   2      
  62   2                      // 1. ±£¥ÊµΩæ˘∫‚»•‡–…˘«Û∫Õ÷–
  63   2                      ad_samp_equ.sum += val_temp;
  64   2                      ad_samp_equ.point++;
  65   2      
  66   2                      // 2. µ±«∞Õ®µ¿ «∑Ò¬˙◊„»•‡–…˘µ„ ˝
  67   2                      if (ad_samp_equ.point == AD_EQU_PNUM) {
  68   3                              // “—¬˙»•‡–…˘µ„ ˝£¨ø…«Û≥ˆæ˘∫‚∫Ûµƒ“ª∏ˆµ„
  69   3                              // 2.a «Û≥ˆ∂‘”¶Õ®µ¿µƒ“ª∏ˆ≤…—˘µ„
  70   3                              val = ad_samp_equ.sum >> 2;  //≥˝”⁄4
  71   3      
  72   3                              // 2.b «Â¡„µ±«∞Õ®µ¿µƒ»•‡–…˘«Û∫ÕΩ·ππ
  73   3                              ad_samp_equ.sum = 0;
  74   3                              ad_samp_equ.point = 0;
  75   3      
  76   3                              // 2.c ±£¥Ê µ ±≤…—˘÷µ
  77   3                              ad_chn_sample.w = val;   //±£¥ÊµΩ◊Ó–¬“ª¬÷≤…—˘÷µ ˝◊È÷–
  78   3      
  79   3                              // 2.d ”…œµÕ≥◊¥Ã¨æˆ∂® ˝æ›µƒ¥¶¿Ì
  80   3                              switch (system_status)
  81   3                              {
  82   4                              case SYS_PowerON:   //…œµÁ
  83   4                              case SYS_B5S:       //5√Î—” ±
  84   4                                      break;
  85   4      
  86   4                              case SYS_SAMP_BASE: //≥ı º…œµÁ ±µƒæ≤Ã¨ª˘◊º÷µ≤…—˘
  87   4                                      //¥Ê»ÎΩ◊∂Œ∫Õ
  88   4                                      ad_samp_sum.sum += val;
  89   4                                      ad_samp_pnum++;
  90   4                                      if (ad_samp_pnum == 32) {
  91   5                                              //“—æ≠¬˙ª˘◊º÷µ≤…—˘µ„ ˝£®√øÕ®µ¿32µ„)
  92   5                                              //1.º∆À„æ˘÷µ∫Õ…œœ¬œﬁ
  93   5                                              //ª˘◊º
  94   5                                              ad_chn_base.base = ad_samp_sum.sum >> 5;   //≥˝”⁄32
  95   5      
  96   5                                              //œ¬œﬁ = ª˘◊º * £®1 / 3£©
  97   5                                              val_temp = ad_chn_base.base;
  98   5                          ad_chn_base.base_down = val_temp - ad_still_Dup;
  99   5      
 100   5                                              //…œœﬁ
 101   5                                              if ((1023 - ad_chn_base.base) > ad_still_Dup) {
 102   6                                                      ad_chn_base.base_up = ad_chn_base.base + ad_still_Dup;
 103   6                                              } else {
 104   6                                                      ad_chn_base.base_up = 1023;
 105   6                                              }
 106   5      
 107   5                                              //∏¥ŒªΩ◊∂Œ∫Õ±‰¡ø£¨◊º±∏”√”⁄◊‘  ”¶∑ß÷µ∏˙◊Ÿ
 108   5                                              ad_samp_sum.sum   = 0;
 109   5                                              ad_samp_sum.point = 0;
 110   5      
 111   5                                              //2.e ◊¥Ã¨->  µ ±ºÏ≤‚
 112   5                                              system_status = SYS_CHECK;
 113   5                                      }
 114   4      
 115   4                                      break;
C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 3   

 116   4      
 117   4                              case SYS_CHECK: // µ ±ºÏ≤‚
 118   4                                      //2. ≈–∂œ «∑ÒÕ‚¡¶±®æØ
 119   4                                      ad_chn_over = ad_chn_over << 1;   //Bit0ÃÓ0£¨“Ú¥À»± °‘⁄‘ –Ì∑∂Œßƒ⁄
 120   4                                      if ((val >= ad_chn_base.base_down) && (val <= ad_chn_base.base_up)) {
 121   5                                              //‘⁄’≈¡¶…œ/œ¬œﬁ‘ –Ì∑∂Œßƒ⁄
 122   5                                              //a. «Â±Í÷æ(»± °)
 123   5                                              //b. º∆»Î∏˙◊Ÿª˘◊º÷µ«Û∫Õ÷–
 124   5                                              ad_samp_sum.sum += val;
 125   5                                              ad_samp_sum.point++;
 126   5      
 127   5                                              if (ad_samp_sum.point == 2) {
 128   6                                                      //¬˙2µ„(‘º–Ë0.6√Î)
 129   6                                                      //b.0 º∆À„’‚2µ„æ˘÷µ
 130   6                                                      val_temp = ad_samp_sum.sum >> 1;   //≥˝”⁄2, µ√µΩ’‚2µ„µƒæ˘÷µ
 131   6                                                      //b.1 ∏¸–¬ª˘◊º÷µ
 132   6                                                      if (ad_chn_base.base > (val_temp + 1)) {                            
 133   7                                  // ÷¡…Ÿ–°”⁄2,ª∫¬˝À…≥⁄
 134   7                                                              md_point++;
 135   7                                                              if (md_point >= DEF_ModiBASE_PT) {
 136   8                                      // “—¬˙ª∫¬˝À…≥⁄ ±µƒ¡¨–¯º∆¡øµ„ ˝, Ω¯––“ª¥Œ∏˙◊Ÿ
 137   8                                                                      // 1. ∏˙◊Ÿª˘◊º÷µ
 138   8                                     if (ad_chn_base.base > 0) {
 139   9                                          //ø…“‘µ›ºı1
 140   9                                          ad_chn_base.base--;
 141   9                                          // Õ¨≤Ω∏¸–¬…œœ¬œﬁ
 142   9                                          val_temp = ad_chn_base.base;
 143   9                                          if ((val_temp - ad_still_Dup) > 0) {
 144  10                                              ad_chn_base.base_down = val_temp - ad_still_Dup;
 145  10                                          }
 146   9                                          
 147   9                                          if (ad_chn_base.base_up > 0) {
 148  10                                              ad_chn_base.base_up--;
 149  10                                          }
 150   9                                      }
 151   8                                                                      // 2. «Âª∫¬˝À…≥⁄∏˙◊Ÿ±‰¡ø
 152   8                                                                      md_point = 0;
 153   8                                                              }
 154   7                                                      } else if (val_temp > (ad_chn_base.base + 1)) {
 155   7                                                              // ÷¡…Ÿ¥Û2, ª∫¬˝’≈ΩÙ
 156   7                                                              md_point++;
 157   7                                                              if (md_point >= DEF_ModiBASE_PT) {
 158   8                                                                      // “—¬˙ª∫¬˝’≈ΩÙ ±µƒ¡¨–¯º∆¡øµ„ ˝, Ω¯––“ª¥Œ∏˙◊Ÿ
 159   8                                                                      // 1. ∏˙◊Ÿª˘◊º÷µ
 160   8                                                                      if (ad_chn_base.base < 1023) {
 161   9                                                                              //ø…“‘µ›‘ˆ1
 162   9                                                                              ad_chn_base.base++;
 163   9                                                                              // Õ¨≤Ω∏¸–¬…œœ¬œﬁ
 164   9                                                                              val_temp = ad_chn_base.base;
 165   9                                          ad_chn_base.base_down = val_temp - ad_still_Dup;
 166   9                                                                              if (ad_chn_base.base_up < 1023) {
 167  10                                                                                      ad_chn_base.base_up++;
 168  10                                                                              }
 169   9                                                                      }
 170   8                                                                      // 2. «Âª∫¬˝’≈ΩÙ∏˙◊Ÿ±‰¡ø
 171   8                                                                      md_point = 0;
 172   8                                                              }
 173   7                                                      }
 174   6      
 175   6                                                      //b.2 ∏¥ŒªΩ◊∂Œ∫Õ±‰¡ø - ”√”⁄4µ„4µ„∆Ωæ˘µƒ«Û∫ÕΩ·ππ
 176   6                                                      ad_samp_sum.sum   = 0;
 177   6                                                      ad_samp_sum.point = 0;
C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 4   

 178   6                                              }
 179   5                                      } else {
 180   5                                              //Õ‚¡¶±®æØ, ÷√±Í÷æ
 181   5                                              ad_chn_over |= 0x01;
 182   5                                      }
 183   4      
 184   4                                      //2.4 ¡¨–¯4µ„≥¨∑∂Œß£¨¥ÀÕ®µ¿”–Õ‚¡¶±®æØ
 185   4                                      if ((ad_chn_over & 0x0F) == 0x0F) {
 186   5                                              //÷√Õ‚¡¶±®æØ±Í÷æ
 187   5                                              ad_alarm_exts |= (Uint16)0x01;
 188   5      
 189   5                                              //±®æØº∆ ±tick«Â¡„
 190   5                                              ad_alarm_tick = 0;
 191   5      
 192   5                                              //¡¢º¥∏¸–¬ª˙÷∆
 193   5                                              ad_chn_base.base = val;
 194   5                                              val_temp = ad_chn_base.base;
 195   5                          ad_chn_base.base_down = val_temp - ad_still_Dup;
 196   5                                              if ((1023 - ad_chn_base.base) > ad_still_Dup) {
 197   6                                                      ad_chn_base.base_up = ad_chn_base.base + ad_still_Dup;
 198   6                                              } else {
 199   6                                                      ad_chn_base.base_up = 1023;
 200   6                                              }
 201   5      
 202   5                                              //∏¥ŒªΩ◊∂Œ∫Õ±‰¡ø - ”√”⁄4µ„4µ„∆Ωæ˘µƒ«Û∫ÕΩ·ππ
 203   5                                              ad_samp_sum.sum = 0;
 204   5                                              ad_samp_sum.point = 0;
 205   5      
 206   5                                              //«Âª∫¬˝’≈ΩÙ∏˙◊Ÿ±‰¡ø
 207   5                                              md_point = 0;   //”√”⁄ª˘◊º÷µ∏˙◊Ÿµƒº∆¡øµ„ ˝
 208   5                                      } else if ((ad_chn_over & 0x0F) == 0x00) {
 209   5                                              //ŒﬁÕ‚¡¶±®æØ
 210   5                                              //ºÏ≤È±®æØ ±º‰ «∑Ò“—µΩ
 211   5                                              if (ad_alarm_tick > ALARM_TEMPO) {
 212   6                                                      //±®æØ“—æ≠µΩ◊Ó¥Û±®æØ ±º‰, Õ£÷π±®æØ
 213   6                                                      ad_alarm_exts &= ~((Uint16)0x01);
 214   6                                              }
 215   5                                      }
 216   4      
 217   4                                      //3 LED÷∏ æ(Œﬁmask)
 218   4                                      temp16 = ad_alarm_exts & 0x0001;
 219   4                                      if (alarm_led_flag != temp16) {
 220   5                                              //LED÷∏ æ–≈œ¢”–±‰ªØ
 221   5                                              alarm_led_flag = temp16;
 222   5                                              P33 = !P33;
 223   5                                      }
 224   4      
 225   4                                      //4 ∏¸–¬±®æØ±Í÷æ
 226   4                                      temp16 = ad_alarm_exts & 0x0001;
 227   4                                      if (temp16 == 0) {
 228   5                                              ad_alarm_flag = 0;   //Œﬁ±®æØ
 229   5                                      } else {
 230   5                                              ad_alarm_flag = 1;   //”–±®æØ
 231   5                                      }
 232   4      
 233   4                                      break;
 234   4                              }
 235   3      
 236   3                              //3.µ±«∞≤…—˘÷µ¥¶¿ÌÕÍ±œ£¨‘ –Ì–¬µƒ≤…—˘÷µ ‰»Î
 237   3                              ad_sample.valid = FALSE;
 238   3                      }
 239   2              }
C51 COMPILER V9.54   ADC_TASK                                                              07/01/2016 17:14:37 PAGE 5   

 240   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    792    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      2    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       2
   IDATA SIZE       =      1    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
